<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>DebugBar</name>
    <code>DebugBar</code>
    <version>0.1</version>
    <author>DKart</author>
    <link>https://dkart.pro</link>

    <file path="system/library/db/mysqli.php">
        <operation>
            <search>
                <![CDATA[class MySQLi {]]>
            </search>
            <add position="before">
                <![CDATA[
			  use debugBar\Builder\DebugBarBuilder;

		    ]]>
            </add>
        </operation>

        <operation>
            <search>
                <![CDATA[$query = $this->connection->query($sql);]]>
            </search>
            <add position="before">
                <![CDATA[
			  DebugBarBuilder::getInstance()->startQueryMicroTime();
		    ]]>
            </add>
        </operation>

        <operation>
            <search>
                <![CDATA[$query = $this->connection->query($sql);]]>
            </search>
            <add position="after">
                <![CDATA[
			  DebugBarBuilder::getInstance()->addQuery($sql);
		    ]]>
            </add>
        </operation>
    </file>

    <file path="system/library/log.php">
        <operation>
            <search>
                <![CDATA[class Log {]]>
            </search>
            <add position="before">
                <![CDATA[
			  use debugBar\Builder\DebugBarBuilder;

		    ]]>
            </add>
        </operation>

        <operation>
            <search>
                <![CDATA[public function write($message) {]]>
            </search>
            <add position="after">
                <![CDATA[
			  DebugBarBuilder::getInstance()->addMessage($message, 'log');
		    ]]>
            </add>
        </operation>
    </file>

    <file path="system/library/template/*.php">
        <operation>
            <search>
                <![CDATA[namespace Template;]]>
            </search>
            <add position="after">
                <![CDATA[

                use debugBar\Builder\DebugBarBuilder;
		    ]]>
            </add>
        </operation>

        <operation>
            <search>
                <![CDATA[$file = ]]>
            </search>
            <add position="after">
                <![CDATA[
			  DebugBarBuilder::getInstance()->addAction($file);
		    ]]>
            </add>
        </operation>
    </file>

    <file path="admin/controller/common/developer.php">
        <operation>
            <search>
                <![CDATA[public function sass() {]]>
            </search>
            <add position="before">
                <![CDATA[
	public function clearAllCache() {
		$this->load->language('common/developer');

		$json = array();

		if (!$this->user->hasPermission('modify', 'common/developer')) {
			$json['error'] = $this->language->get('error_permission');
		} else {

            // Clear theme sass
            $this->sass();

            // Clear theme cache
            $this->theme();

            // Modification refresh
            $this->load->controller('marketplace/modification/refresh', ['json' => true]);

            $json['success'] = sprintf($this->language->get('text_cache'), $this->language->get('text_theme'));
		}

		$this->response->addHeader('Content-Type: application/json');
		$this->response->setOutput(json_encode($json));
	}
		    ]]>
            </add>
        </operation>
    </file>


    <file path="admin/controller/marketplace/modification.php">
        <operation>
            <search>
                <![CDATA[// Do not return success message if refresh() was called with $data]]>
            </search>
            <add position="before">
                <![CDATA[
                if(isset($data['json'])) {
                    return true;
                }
		    ]]>
            </add>
        </operation>
    </file>

</modification>
